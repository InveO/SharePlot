package jet.shareplot.ac.bo.portfolio;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.Callable;

import javax.ejb.ObjectNotFoundException;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import javax.transaction.RollbackException;
import javax.transaction.TransactionManager;

import org.eclipse.jdt.annotation.NonNull;
import org.eclipse.jdt.annotation.Nullable;

import jet.container.managers.jta.interfaces.JTAManagerContext;
import jet.framework.component.SimpleApplicationComponent;
import jet.framework.manager.datamodel.interfaces.ModelArray;
import jet.framework.nuts.select.FinderMethod;
import jet.framework.nuts.select.SelectNutHelper;
import jet.framework.util.JetConstants;
import jet.framework.util.jta.TransactionHelper;
import jet.shareplot.persistence.finder.portfolio.Portfolio_FindAll0;
import jet.shareplot.persistence.imut.PortfolioImut;
import jet.util.logger.JETLevel;
import jet.util.models.interfaces.Model;
import jet.util.throwable.JETException;

/**
 * Portfolio manipulation API.
 *
 * Generated by JetTools, do not change this file, it will be overriden at each generation.
 *
 * @author JetToolsFramework
 */
abstract class AbstractPortfolioBOApplicationComponent extends SimpleApplicationComponent {

    private static final long serialVersionUID = 993423458L;

    private transient TransactionManager transactionManager;

    /**
     * Get an instance of the POJO2 business object for the data model.
     *
     * @param model Data model
     * @return instance of the POJO2 business object
     */
    protected abstract @NonNull Portfolio getPortfolio(final @NonNull Model model);

    /**
     * Return all portfolio matching the FinderMethod.
     *
     * @param finder FinderMethod to use to fetch the Portfolios
     * @return a list of portfolio matching the FinderMethod.
     * @see List
     * @see Portfolio
     */
    protected @NonNull List<@NonNull Portfolio> getPortfolios(final @NonNull FinderMethod<PortfolioImut> finder) {
        final List<@NonNull Portfolio> result = new ArrayList<>();

        final Callable<@Nullable Object> callable = new Callable<@Nullable Object>() {
            @Override
            public Object call() throws Exception {
                final ModelArray ma = SelectNutHelper.getModelArray(finder, getLogger());
                if (ma != null) {
                    final int size = ma.getSize();
                    for (int i = 0; i < size; i++) {
                        final @NonNull Model model = ma.get(i);
                        final Portfolio portfolio = getPortfolio(model);
                        result.add(portfolio);
                    }
                }
                return null;
            }
        };
        try {
            final TransactionManager transactionMgr = getTransactionManager();
            TransactionHelper.runTransaction(callable, transactionMgr);
        } catch (final ObjectNotFoundException e) {
            logp(JETLevel.SEVERE, "AbstractPortfolioBOApplicationComponent", "getPortfolios", e.getMessage(), e);
        } catch (final JETException e) {
            logp(JETLevel.SEVERE, "AbstractPortfolioBOApplicationComponent", "getPortfolios", e.getMessage(), e);
        } catch (final RollbackException e) {
            logp(JETLevel.SEVERE, "AbstractPortfolioBOApplicationComponent", "getPortfolios", e.getMessage(), e);
        } catch (final NamingException e) {
            logp(JETLevel.SEVERE, "AbstractPortfolioBOApplicationComponent", "getPortfolios", e.getMessage(), e);
        }

        return result;
    }

    /**
     * Return all portfolio matching the FinderMethod.
     *
     * @param finder FinderMethod to use to fetch the Portfolios
     * @return a list of portfolio matching the FinderMethod.
     * @see List
     * @see Portfolio
     */
    protected @NonNull List<@NonNull PortfolioImut> getPortfolioImuts(final @NonNull FinderMethod<PortfolioImut> finder) {
        final List<@NonNull PortfolioImut> result = new ArrayList<>();

        final Callable<@NonNull List<@NonNull PortfolioImut>> callable = new Callable<@NonNull List<@NonNull PortfolioImut>>() {
            @Override
            public @NonNull List<@NonNull PortfolioImut> call() throws Exception {
                return finder.callImutFinder();
            }
        };
        try {
            final TransactionManager transactionMgr = getTransactionManager();
            result.addAll(TransactionHelper.runTransaction(callable, transactionMgr));
        } catch (final ObjectNotFoundException e) {
            logp(JETLevel.SEVERE, "AbstractPortfolioBOApplicationComponent", "getPortfolioImuts", e.getMessage(), e);
        } catch (final JETException e) {
            logp(JETLevel.SEVERE, "AbstractPortfolioBOApplicationComponent", "getPortfolioImuts", e.getMessage(), e);
        } catch (final RollbackException e) {
            logp(JETLevel.SEVERE, "AbstractPortfolioBOApplicationComponent", "getPortfolioImuts", e.getMessage(), e);
        } catch (final NamingException e) {
            logp(JETLevel.SEVERE, "AbstractPortfolioBOApplicationComponent", "getPortfolioImuts", e.getMessage(), e);
        }

        return result;
    }

    private TransactionManager getTransactionManager() throws NamingException {
        if (this.transactionManager == null) {
            final JTAManagerContext jtaCtxt = (JTAManagerContext) new InitialContext().lookup(JetConstants.MANAGERS_CONTEXT + JTAManagerContext.NAME);
            this.transactionManager = jtaCtxt.getTransactionManager();
        }
        return this.transactionManager;
    }

    /**
     * Return the first portfolio matching the FinderMethod.
     *
     * @param finder FinderMethod to use to fetch the Portfolio
     * @return the portfolio matching the FinderMethod.
     * @see Portfolio
     */
    protected @Nullable Portfolio getPortfolio(final @NonNull FinderMethod<PortfolioImut> finder) {
        final Portfolio result;

        final Model model = SelectNutHelper.getModel(finder, getLogger());
        if (model == null) {
            result = null;
        } else {
            result = getPortfolio(model);
        }

        return result;
    }

    /**
     * Sample method making a call to getPortfolios(final FinderMethod finder).
     *
     * @return a list of portfolio matching the FinderMethod.
     * @see List
     * @see Portfolio
     * @see #getPortfolios(FinderMethod finder)
     */
    public @NonNull List<@NonNull Portfolio> getPortfolios() {
        final Portfolio_FindAll0 finder = new Portfolio_FindAll0();

        return getPortfolios(finder);
    }
}
